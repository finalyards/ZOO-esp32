# `v53l5cx_uld`

Turns the `VL53L5CX_ULD_API` source code into something that can be used in Rust applications.

>Note: Usually Rust/C bindings are done in two layers: a `-sys` library forming a 1-to-1 bridging to C code, and another library adapting the use for Rust.
>
>We *kind of* have this approach, by having a a `src/uld_raw.rs` generated by `bindgen` from C sources. But these are in the one Rust module, not two separate.
>Currently, we are keeping everything together (for simplicity); depends on the amount of Rust adaptation.

**The one thing this level doesn't do is *be aware of Embassy* in any way (`async/.await`).**

## Pre-reading

- ["Using C Libraries in Rust"](https://medium.com/dwelo-r-d/using-c-libraries-in-rust-13961948c72a) (blog, Aug '19)

   A bit old, but relevant (C API's don't age!).
   
## The job

![](.images/bindgen-jumps.png)

><font color=orange>*tbd. CHANGES TO THE IMAGE ARE LIKELY!*</font>


## Requirements

See hardware and software requirements -> [`../README`](../README.md).

### `bindgen`

Install dependencies:

```
$ sudo apt install llvm-dev libclang-dev clang
```

```
$ cargo install bindgen-cli
```

>Note: Bindgen docs recommend using it as a library, but we prefer to use it as a command line tool.


## Preparation

### The vendor C libary

The [VL53L5CX_ULD library](https://www.st.com/en/embedded-software/stsw-img023.html) is a separate download.

1. Fetch it from ST (link above)
2. Unzip and place it to `./VL53L5CX_ULD_driver_2.0.0`

	Note that while you need to `Agree` to the larger ST.com license, it has the clause: 
	
	>Open Source Software [...] is not subject to the terms of this PLLA to the extent [...]
	
	Overall, the ST.com licensing seems awkward to the author; that's why I'm leaving this part to you!  In practise, the above part is likely BSD 3-clause, but the process doesn't make it at all clear!!! **@ST.com: please, you can improve upon this.**


### Supported dev kits

The workflow has been tested on these MCUs:

|||
|---|---|
|`esp32c3` (default)|[ESP32-C3-DevKitC-02](https://docs.espressif.com/projects/esp-idf/en/stable/esp32c3/hw-reference/esp32c3/user-guide-devkitc-02.html) dev kit, with JTAG/USB wiring added|
|`esp32c6`|[ESP32-C6-DevKitM-01](https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32c6/esp32-c6-devkitm-1/user_guide.html)|
|`esp32`|[Adafruit ESP32 Feather V2](https://www.adafruit.com/product/5400); use a separate branch `adafruit-feather-v2`|

Between RISC V variants, the code allows you to change targets rather easily, back and forth. To do this, run `./set-target.sh` .

### Wiring

See [WIRING](./WIRING.md).

## Compiling 

```
$ cargo build --release
```

>The command uses `Makefile.inner` internally. If there are problems with the build, you may want to run the Makefile separately (see below). Also, have a look at its contents.
>
>```
>$ make -f Makefile.inner src/uld_raw.rs tmp/libvendor_uld.a
>```

## Running samples

```
$ cargo run --release --features=defmt --example nada
[...]
      Erasing ✔ [00:00:03] [#############] 192.00 KiB/192.00 KiB @ 53.17 KiB/s (eta 0s )
  Programming ✔ [00:00:18] [#############] 22.54 KiB/22.54 KiB @ 1.23 KiB/s (eta 0s )    Finished in 18.28534s
INFO  Nada
DEBUG Ding!
DEBUG Dong!
...
```

```
$ cargo run --release --features=defmt,distance_mm --example _1-ranging_basic
```

|||
|---|---|
|`nada`|Checks the build setup and `defmt` logging; no sensor activity|
|`_1-ranging_basic`|...|


*tbd. Hardware setup for those.*

## Troubleshooting

### General

Make sure you've installed `probe-rs` from GitHub. Stock version 0.24.0 is NOT FRESH ENOUGH!

### No log output (ESP32-C3 only)

```
$ probe-rs run --log-format '{L}_{s}' target/riscv32imc-unknown-none-elf/release/examples/nada
      Erasing ✔ [00:00:03] [################] 192.00 KiB/192.00 KiB @ 57.05 KiB/s (eta 0s )
  Programming ✔ [00:00:18] [################] 22.54 KiB/22.54 KiB @ 1.25 KiB/s (eta 0s )    Finished in 18.072815s



```

The C3 board may needs a physical reset (and reattaching) prior to each run.

- keep both `RESET` and `BOOT` buttons pressed; release `RESET`
- release `BOOT`

This sets the device in "download mode".

- push the `RESET` button
- re-attach on USB/IP: e.g. `sudo attach -r 192.168.1.29 -b 3-1`
- try again


## Prior art

I had a look at these at the *early stages* of developing the repo. In addition, I've heard of a Rust adaptation that wasn't likely published.

- [`stm32duino/VL53L5CX`](https://github.com/stm32duino/VL53L5CX)

   *"Arduino library to support the VL53L5CX Time-of-Flight 8x8 multizone ranging sensor [...]"*

- [`RJRP44/VL53L5CX-Library`](https://github.com/RJRP44/VL53L5CX-Library/blob/master/README.md) (Jun'22 - Apr'24; BSD 3-clause license)

   *"A vl53l5cx library for esp32 using the esp-idf framework"*
   
- [`kriswiner/VL53L5CX`](https://github.com/kriswiner/VL53L5CX) (GitHub; 2021)
- [`simondlevy/VL53L5CX`](https://github.com/simondlevy/VL53L5CX) (GitHub; 2021)
	
	
## References

### VL53L5CX

- [Breakout Boards for VL53L5CX](https://www.st.com/en/evaluation-tools/vl53l5cx-satel.html) (ST.com)
- [Ultra Lite Driver (ULD) for VL53L5CX multi-zone sensor](https://www.st.com/en/embedded-software/stsw-img023.html) (ST.com)

	- ["Ultra lite driver (ULD) [...] with wide field of view"](https://www.st.com/resource/en/data_brief/stsw-img023.pdf) (PDF, May'21; 3pp)
	- ["A guide to using the VL53L5CX multizone [...]"](https://www.st.com/resource/en/user_manual/um2884-a-guide-to-using-the-vl53l5cx-multizone-timeofflight-ranging-sensor-with-a-wide-field-of-view-ultra-lite-driver-uld-stmicroelectronics.pdf) (PDF, revised Feb'24; 18pp)

		<font size=5 color=red>⇫</font> The main API usage guide

	- [Software licensing agreement](https://www.st.com/resource/en/license_agreement/dm00484327.pdf) (PDF, Feb'18; 5pp)

